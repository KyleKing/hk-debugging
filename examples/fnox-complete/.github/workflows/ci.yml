name: CI/CD Pipeline with fnox

on:
  push:
    branches: [main, staging, develop]
  pull_request:
    branches: [main, staging]

env:
  NODE_VERSION: '20'

jobs:
  # ===========================================================================
  # Test Job - Run tests with CI secrets
  # ===========================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # Install mise (tool version manager)
      - name: Install mise
        uses: jdx/mise-action@v2
        with:
          version: latest

      # Install fnox via mise
      - name: Install fnox
        run: mise use -g fnox

      # Setup age encryption key for CI
      - name: Setup fnox age key
        env:
          FNOX_AGE_KEY: ${{ secrets.FNOX_AGE_KEY }}
        run: |
          mkdir -p ~/.config/fnox
          echo "$FNOX_AGE_KEY" > ~/.config/fnox/age.key
          chmod 600 ~/.config/fnox/age.key

      # Install dependencies
      - name: Install dependencies
        run: npm ci

      # Run linting
      - name: Lint
        run: npm run lint

      # Run tests with fnox CI profile
      - name: Run tests
        run: fnox exec --profile ci -- npm test

      # Upload coverage (optional)
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false

  # ===========================================================================
  # Build Job - Verify application builds
  # ===========================================================================
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install mise
        uses: jdx/mise-action@v2

      - name: Install fnox
        run: mise use -g fnox

      - name: Setup fnox age key
        env:
          FNOX_AGE_KEY: ${{ secrets.FNOX_AGE_KEY }}
        run: |
          mkdir -p ~/.config/fnox
          echo "$FNOX_AGE_KEY" > ~/.config/fnox/age.key
          chmod 600 ~/.config/fnox/age.key

      - name: Install dependencies
        run: npm ci

      # Build with CI secrets
      - name: Build
        run: fnox exec --profile ci -- npm run build

      # Upload build artifacts
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

  # ===========================================================================
  # Deploy to Staging - Use AWS Secrets Manager
  # ===========================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/staging'
    environment:
      name: staging
      url: https://staging.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install mise
        uses: jdx/mise-action@v2

      - name: Install fnox
        run: mise use -g fnox

      # Configure AWS credentials for Secrets Manager access
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_STAGING }}
          aws-region: us-east-1

      # Download build artifacts
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts
          path: dist/

      # Deploy with staging secrets from AWS Secrets Manager
      - name: Deploy to staging
        run: |
          echo "Deploying to staging with AWS Secrets Manager..."
          fnox exec --profile staging -- ./scripts/deploy.sh staging

      # Health check
      - name: Health check
        run: |
          sleep 10
          curl -f https://staging.example.com/health || exit 1

  # ===========================================================================
  # Deploy to Production - Use AWS Secrets Manager
  # ===========================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install mise
        uses: jdx/mise-action@v2

      - name: Install fnox
        run: mise use -g fnox

      # Configure AWS credentials for production
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_PRODUCTION }}
          aws-region: us-east-1

      # Download build artifacts
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts
          path: dist/

      # Deploy with production secrets
      - name: Deploy to production
        run: |
          echo "Deploying to production with AWS Secrets Manager..."
          fnox exec --profile production -- ./scripts/deploy.sh production

      # Health check
      - name: Health check
        run: |
          sleep 10
          curl -f https://example.com/health || exit 1

      # Notify deployment
      - name: Notify deployment
        if: always()
        run: |
          # Add your notification logic here (Slack, email, etc.)
          echo "Production deployment completed: ${{ job.status }}"

  # ===========================================================================
  # Security Scan - Check for vulnerabilities
  # ===========================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      # Run npm audit
      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

      # Scan for secrets in code (prevent accidental commits)
      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  # ===========================================================================
  # Integration Tests - Run against staging
  # ===========================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/staging'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install mise
        uses: jdx/mise-action@v2

      - name: Install fnox
        run: mise use -g fnox

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_STAGING }}
          aws-region: us-east-1

      - name: Install dependencies
        run: npm ci

      # Run integration tests against staging
      - name: Run integration tests
        env:
          TEST_URL: https://staging.example.com
        run: fnox exec --profile staging -- npm run test:integration
